# ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜ Open API ì—°ë™ ê°€ì´ë“œ

## ê°œìš”
ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜ ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ ì˜ì–‘ì„±ë¶„ ì •ë³´ Open APIë¥¼ í†µí•´ ìµœì‹  ë°ì´í„°ë¥¼ ìë™ìœ¼ë¡œ ë™ê¸°í™”í•˜ëŠ” ê¸°ëŠ¥

## API ì •ë³´

- **API ëª…**: ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ ì˜ì–‘ì„±ë¶„ ì •ë³´ ì¡°íšŒ ì„œë¹„ìŠ¤
- **ì œê³µ ê¸°ê´€**: ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜
- **ì—”ë“œí¬ì¸íŠ¸**: `https://api.data.go.kr/openapi/tn_pubr_public_health_functional_food_nutrition_info_api`
- **ë°ì´í„° í¬ë§·**: JSON, XML
- **ì¸ì¦ ë°©ì‹**: Service Key

## í™˜ê²½ ì„¤ì •

### 1. API í‚¤ ë°œê¸‰

1. [ê³µê³µë°ì´í„°í¬í„¸](https://www.data.go.kr/) ì ‘ì†
2. íšŒì›ê°€ì… / ë¡œê·¸ì¸
3. "ê±´ê°•ê¸°ëŠ¥ì‹í’ˆ ì˜ì–‘ì„±ë¶„ ì •ë³´" ê²€ìƒ‰
4. í™œìš©ì‹ ì²­ â†’ ìŠ¹ì¸ ëŒ€ê¸° (ë³´í†µ 1-2ì‹œê°„)
5. ìŠ¹ì¸ í›„ ì¸ì¦í‚¤ ë°œê¸‰

### 2. .env íŒŒì¼ ì„¤ì •

```bash
# ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜ Open API
FOOD_SAFETY_API_KEY=your_api_key_here
```

**í˜„ì¬ ì„¤ì •ëœ í‚¤**:
```
7ef00491041db425e0a8ab59aba911aa95484d2ebef66177c64450c197fa4155
```

## ì‚¬ìš© ë°©ë²•

### ë°©ë²• 1: API í…ŒìŠ¤íŠ¸

```bash
# API ì—°ê²° ë° ì‘ë‹µ í™•ì¸
node test-food-api.mjs
```

**ì˜ˆìƒ ì¶œë ¥**:
```
ğŸ“¡ ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜ API í…ŒìŠ¤íŠ¸ ì¤‘...
âœ… API ì‘ë‹µ ì„±ê³µ!
ğŸ“Š ì‘ë‹µ ìƒíƒœ: 200
ğŸ“¦ ì‘ë‹µ ë°ì´í„°: {...}
```

### ë°©ë²• 2: ì „ì²´ ë°ì´í„° ë™ê¸°í™”

```bash
# APIì—ì„œ ëª¨ë“  ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ Supabase ì—…ë°ì´íŠ¸
node sync-nutrition-from-api.mjs
```

**ì²˜ë¦¬ ê³¼ì •**:
1. APIì—ì„œ í˜ì´ì§€ë³„(1000ê±´ì”©) ë°ì´í„° ì¡°íšŒ
2. í•œê¸€ ì»¬ëŸ¼ëª… â†’ ì˜ë¬¸ ìë™ ë§¤í•‘
3. Supabase nutrition_info í…Œì´ë¸”ì— upsert
4. ì§„í–‰ë¥  í‘œì‹œ

**ì˜ˆìƒ ì¶œë ¥**:
```
ğŸ”„ ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜ API ë°ì´í„° ë™ê¸°í™” ì‹œì‘...
ğŸ“¡ API ìš”ì²­: í˜ì´ì§€ 1, 1000ê±´
ğŸ“Š ì´ 4380ê±´ì˜ ë°ì´í„° ë°œê²¬
âœ… 1000/4380 ë™ê¸°í™” ì™„ë£Œ (23%)
âœ… 2000/4380 ë™ê¸°í™” ì™„ë£Œ (46%)
...
âœ… ë™ê¸°í™” ì™„ë£Œ! ì´ 4380ê±´ ì—…ë°ì´íŠ¸
```

## API ì‘ë‹µ êµ¬ì¡°

### ìš”ì²­ íŒŒë¼ë¯¸í„°

| íŒŒë¼ë¯¸í„° | íƒ€ì… | í•„ìˆ˜ | ì„¤ëª… | ì˜ˆì‹œ |
|---------|------|------|------|------|
| serviceKey | String | Y | ì¸ì¦í‚¤ | ë°œê¸‰ë°›ì€ í‚¤ |
| pageNo | Integer | Y | í˜ì´ì§€ ë²ˆí˜¸ | 1 |
| numOfRows | Integer | Y | í•œ í˜ì´ì§€ ê²°ê³¼ ìˆ˜ | 1000 |
| type | String | Y | ì‘ë‹µ í˜•ì‹ | json ë˜ëŠ” xml |

### ì‘ë‹µ ì˜ˆì‹œ (JSON)

```json
{
  "response": {
    "header": {
      "resultCode": "00",
      "resultMsg": "NORMAL_CODE"
    },
    "body": {
      "items": [
        {
          "ì‹í’ˆì½”ë“œ": "F102-054540000-0037",
          "ì‹í’ˆëª…": "íë¦¬ ì— ì—ìŠ¤ì—  770",
          "ì œì¡°ì‚¬ëª…": "PIONITY HEALTH&BIO EXPERT GROUP",
          "ì—ë„ˆì§€(kcal)": "3",
          "ë‹¨ë°±ì§ˆ(g)": "0.00",
          ...
        }
      ],
      "totalCount": 4380,
      "pageNo": 1,
      "numOfRows": 1000
    }
  }
}
```

## ì£¼ìš” ê¸°ëŠ¥

### 1. ë°ì´í„° ë³€í™˜
- **í•œê¸€ ì»¬ëŸ¼ëª… â†’ ì˜ë¬¸**: `'ì‹í’ˆì½”ë“œ'` â†’ `'food_code'`
- **ìˆ«ì íƒ€ì… ìë™ ë³€í™˜**: `"3"` â†’ `3`
- **null ì²˜ë¦¬**: ë¹ˆ ë¬¸ìì—´ â†’ `null`

### 2. ë°°ì¹˜ ì²˜ë¦¬
- 1000ê±´ì”© í˜ì´ì§• ì²˜ë¦¬
- API ë¶€í•˜ ë°©ì§€ë¥¼ ìœ„í•œ 1ì´ˆ ë”œë ˆì´

### 3. ì¤‘ë³µ ì²˜ë¦¬
- `food_code` ê¸°ì¤€ upsert
- ê¸°ì¡´ ë°ì´í„°ëŠ” ì—…ë°ì´íŠ¸, ì‹ ê·œ ë°ì´í„°ëŠ” ì‚½ì…

## íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Issue 1: API í‚¤ ì˜¤ë¥˜

**ì¦ìƒ**:
```
ì‘ë‹µ ìƒíƒœ: 401
SERVICE KEY IS NOT REGISTERED ERROR
```

**í•´ê²°**:
- API í‚¤ê°€ ì •í™•í•œì§€ í™•ì¸
- í™œìš©ì‹ ì²­ ìŠ¹ì¸ ì—¬ë¶€ í™•ì¸
- Encodingëœ í‚¤ ì‚¬ìš© (Decodingëœ í‚¤ X)

### Issue 2: ì‘ë‹µ êµ¬ì¡° ë¶ˆì¼ì¹˜

**ì¦ìƒ**:
```
âš ï¸ ì˜ˆìƒì¹˜ ëª»í•œ ì‘ë‹µ í˜•ì‹
```

**í•´ê²°**:
`sync-nutrition-from-api.mjs`ì˜ ì‘ë‹µ íŒŒì‹± ë¡œì§ ì¡°ì •:
```javascript
const data = response.data.response?.body?.items ||
             response.data.items ||
             response.data
```

### Issue 3: ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜

**ì¦ìƒ**:
```
âŒ API ìš”ì²­ ì‹¤íŒ¨: getaddrinfo ENOTFOUND
```

**ê°€ëŠ¥í•œ ì›ì¸**:
- ë°©í™”ë²½/í”„ë¡ì‹œ ì„¤ì •
- DNS í•´ì„ ë¬¸ì œ
- ë„¤íŠ¸ì›Œí¬ ì—°ê²° ëŠê¹€

**í•´ê²°**:
- ì¸í„°ë„· ì—°ê²° í™•ì¸
- í”„ë¡ì‹œ ì„¤ì • í™•ì¸
- ë‹¤ë¥¸ ë„¤íŠ¸ì›Œí¬ í™˜ê²½ì—ì„œ ì‹œë„

## ì •ê¸° ì—…ë°ì´íŠ¸ ì„¤ì •

### Cron Job (Linux/Mac)

```bash
# ë§¤ì¼ ìƒˆë²½ 2ì‹œì— ë°ì´í„° ë™ê¸°í™”
0 2 * * * cd /path/to/dev2 && node sync-nutrition-from-api.mjs >> logs/sync.log 2>&1
```

### Windows Task Scheduler

1. ì‘ì—… ìŠ¤ì¼€ì¤„ëŸ¬ ì—´ê¸°
2. ê¸°ë³¸ ì‘ì—… ë§Œë“¤ê¸°
3. íŠ¸ë¦¬ê±°: ë§¤ì¼ ìƒˆë²½ 2ì‹œ
4. ì‘ì—…: `node sync-nutrition-from-api.mjs`

### GitHub Actions (ìë™í™”)

```yaml
name: Sync Nutrition Data

on:
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ìƒˆë²½ 2ì‹œ (UTC)

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3
      - uses: actions/setup-node@v3
        with:
          node-version: '18'
      - run: npm install
      - run: node sync-nutrition-from-api.mjs
        env:
          FOOD_SAFETY_API_KEY: ${{ secrets.FOOD_SAFETY_API_KEY }}
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
```

## ì£¼ì˜ì‚¬í•­

1. **API í˜¸ì¶œ ì œí•œ**: ì¼ì¼ í˜¸ì¶œ íšŸìˆ˜ ì œí•œ í™•ì¸ (ë³´í†µ 1000-10000íšŒ)
2. **ìš”ì²­ ê°„ê²©**: ê³¼ë„í•œ ìš”ì²­ ë°©ì§€ë¥¼ ìœ„í•´ ë”œë ˆì´ ì„¤ì •
3. **ë°ì´í„° ì •í™•ì„±**: API ì‘ë‹µ ë°ì´í„° ê²€ì¦ í•„ìš”
4. **API í‚¤ ë³´ì•ˆ**: `.env` íŒŒì¼ì„ gitì— ì»¤ë°‹í•˜ì§€ ë§ ê²ƒ

## íŒŒì¼ êµ¬ì¡°

```
test-food-api.mjs          # API ì—°ê²° í…ŒìŠ¤íŠ¸
sync-nutrition-from-api.mjs # ë°ì´í„° ë™ê¸°í™” ìŠ¤í¬ë¦½íŠ¸
.env                        # API í‚¤ ì„¤ì •
README-food-api.md          # ì´ ë¬¸ì„œ
```

## ì°¸ê³  ìë£Œ

- [ê³µê³µë°ì´í„°í¬í„¸](https://www.data.go.kr/)
- [ì‹í’ˆì˜ì•½í’ˆì•ˆì „ì²˜](https://www.mfds.go.kr/)
- [API í™œìš© ê°€ì´ë“œ](https://www.data.go.kr/tcs/dss/selectApiDataDetailView.do?publicDataPk=15127380)

## ë‹¤ìŒ ë‹¨ê³„

1. **ì¦ë¶„ ë™ê¸°í™”**: ë³€ê²½ëœ ë°ì´í„°ë§Œ ì—…ë°ì´íŠ¸
2. **ì˜¤ë¥˜ ë³µêµ¬**: ì‹¤íŒ¨ ì‹œ ìë™ ì¬ì‹œë„
3. **ì•Œë¦¼ ê¸°ëŠ¥**: ë™ê¸°í™” ì™„ë£Œ/ì‹¤íŒ¨ ì‹œ ìŠ¬ë™/ì´ë©”ì¼ ì•Œë¦¼
4. **ë°ì´í„° ê²€ì¦**: ë™ê¸°í™” í›„ ë°ì´í„° ë¬´ê²°ì„± ê²€ì‚¬
