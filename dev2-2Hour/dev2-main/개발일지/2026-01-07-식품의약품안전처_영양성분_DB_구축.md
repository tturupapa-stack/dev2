# 2026-01-07 개발일지: 식품의약품안전처 건강기능식품 영양성분 DB 구축

## 작업 개요
식품의약품안전처의 건강기능식품 영양성분 정보 4,380건을 Supabase nutrition_info 테이블에 업로드

## 작업 배경
- 건강기능식품 리뷰 팩트체크를 위한 영양성분 기준 데이터 필요
- 식약처 공식 데이터를 활용하여 제품 영양성분 검증 기능 구현 예정

## 주요 작업 내용

### 1. CSV 파일 분석
**파일**:
- `products_master.csv`: 컬럼 메타데이터 (필드 설명)
- `식품의약품안전처_건강기능식품영양성분정보_20251230.csv`: 실제 데이터 (4,380건)

**주요 컬럼**:
- 식품 기본 정보: 식품코드, 식품명, 제조사명 등
- 식품 분류: 대/중/소/세분류
- 영양성분: 에너지, 단백질, 지방, 탄수화물, 식이섬유 등
- 비타민: A, C, D, 티아민, 리보플라빈, 니아신 등
- 무기질: 칼슘, 철, 인, 칼륨, 나트륨 등
- 제조/유통 정보: 제조사, 수입업체, 원산지 등

### 2. Supabase 테이블 설계
**파일**: `database/create_nutrition_info_table.sql`

**테이블명**: `nutrition_info`

**스키마 구조**:
```sql
CREATE TABLE nutrition_info (
  id BIGSERIAL PRIMARY KEY,
  food_code TEXT UNIQUE NOT NULL,  -- 식품코드 (고유 식별자)
  food_name TEXT,                   -- 식품명

  -- 60+ 컬럼 (식품 분류, 영양성분, 비타민, 무기질 등)

  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW()
);
```

**주요 특징**:
- `food_code`를 UNIQUE 제약 조건으로 설정
- 5개 인덱스 생성 (food_code, food_name, manufacturer_name 등)
- `updated_at` 자동 갱신 트리거 구현
- NUMERIC 타입 사용으로 정확한 영양성분 값 저장

### 3. 데이터 업로드 스크립트 작성
**파일**: `upload-nutrition-info.mjs`

**주요 기능**:
```javascript
// 1. CSV 컬럼명 매핑 (한글 → 영문)
const COLUMN_MAPPING = {
  '식품코드': 'food_code',
  '식품명': 'food_name',
  '에너지(kcal)': 'energy_kcal',
  // ... 60개 컬럼
}

// 2. 숫자 컬럼 자동 파싱
function parseNumeric(value) {
  if (!value || value.trim() === '') return null
  return parseFloat(value)
}

// 3. 배치 업로드 (1000건씩)
for (let i = 0; i < data.length; i += 1000) {
  await supabase.from('nutrition_info').upsert(batch)
}
```

### 4. 테이블 생성 스크립트
**파일**:
- `create-nutrition-table.mjs`: Supabase JavaScript SDK 사용 (RPC 필요)
- `create-table-pg.mjs`: PostgreSQL 클라이언트 직접 연결
- 최종: **Supabase 웹 콘솔**에서 SQL 직접 실행

### 5. 설명 문서 작성
**파일**: `README-nutrition-setup.md`

테이블 생성 및 데이터 업로드 가이드 제공

## 트러블슈팅

### Issue 1: 모든 컬럼 값이 null로 파싱
**문제**:
```javascript
샘플 데이터: {
  food_code: null,
  food_name: null,
  // 모든 값이 null
}
```

**원인**:
- CSV 파일을 EUC-KR로 읽으면서 컬럼명이 깨짐
- 예: `'식품코드'` → `'癤우떇�뭹肄붾뱶'`

**해결**:
```javascript
// 변경 전
const buffer = fs.readFileSync(csvPath)
const fileContent = iconv.decode(buffer, 'euc-kr')

// 변경 후
const fileContent = fs.readFileSync(csvPath, 'utf-8')
const cleanedContent = fileContent.replace(/^\uFEFF/, '') // BOM 제거
```

### Issue 2: BOM (Byte Order Mark) 처리
**문제**: CSV 파일 첫 줄에 `﻿` (BOM) 존재

**해결**: 정규식으로 BOM 제거
```javascript
const cleanedContent = fileContent.replace(/^\uFEFF/, '')
```

### Issue 3: Supabase SDK로 테이블 생성 불가
**문제**: Supabase JavaScript SDK는 DDL (CREATE TABLE) 실행 불가

**시도한 방법**:
1. `supabase.rpc('exec_sql')` → RPC 함수 없음
2. PostgreSQL 클라이언트 사용 → DATABASE_URL 환경변수 필요

**최종 해결**: Supabase 웹 콘솔 SQL Editor에서 직접 실행

## 업로드 결과

### 데이터 통계
- **총 레코드**: 4,380건
- **업로드 방식**: 배치 업로드 (1000건씩)
- **소요 시간**: 약 20초
- **성공률**: 100%

### 샘플 데이터
```javascript
{
  food_code: 'F102-054540000-0037',
  food_name: '힐리 엠에스엠 770',
  manufacturer_name: 'PIONITY HEALTH&BIO EXPERT GROUP',
  energy_kcal: 3,
  protein_g: 0,
  fat_g: 0,
  carbohydrate_g: 0.5,
  sodium_mg: 0,
  origin_country_name: '미국'
}
```

## 기술 스택

### 새로 추가된 패키지
```json
{
  "pg": "^8.x" // PostgreSQL 클라이언트
}
```

### 사용 기술
- **Node.js + JavaScript**: 업로드 스크립트
- **csv-parse**: CSV 파싱
- **iconv-lite**: 인코딩 변환 (사용하지 않음, UTF-8로 충분)
- **Supabase JavaScript SDK**: 배치 upsert
- **PostgreSQL**: 테이블 생성 SQL

## 파일 구조

```
database/
  └── create_nutrition_info_table.sql    # 테이블 생성 SQL

upload-nutrition-info.mjs                # 데이터 업로드 스크립트
create-nutrition-table.mjs               # Supabase SDK 테이블 생성 시도
create-table-pg.mjs                      # PostgreSQL 클라이언트 테이블 생성
README-nutrition-setup.md                # 구축 가이드

식품의약품안전처_건강기능식품영양성분정보_20251230.csv  # 원본 데이터
products_master.csv                      # 컬럼 메타데이터
```

## Git 커밋 내역

```
commit 9cd5ee4
feat: 식품의약품안전처 건강기능식품 영양성분 DB 구축

- database/create_nutrition_info_table.sql: 60+ 컬럼 테이블 정의
- upload-nutrition-info.mjs: 4,380건 배치 업로드
- 한글 컬럼명 → 영문 자동 매핑
- UTF-8 인코딩 + BOM 제거 처리
```

## 활용 방안

### 1. 제품 영양성분 검증
```javascript
// 제품명으로 영양성분 조회
const { data } = await supabase
  .from('nutrition_info')
  .select('*')
  .ilike('food_name', '%루테인%')
```

### 2. 제조사별 제품 검색
```javascript
const { data } = await supabase
  .from('nutrition_info')
  .select('food_name, energy_kcal, protein_g')
  .eq('manufacturer_name', 'California Gold Nutrition')
```

### 3. 영양성분 비교 분석
```javascript
// 비타민 D 함량 높은 순
const { data } = await supabase
  .from('nutrition_info')
  .select('food_name, vitamin_d_ug')
  .not('vitamin_d_ug', 'is', null)
  .order('vitamin_d_ug', { ascending: false })
  .limit(10)
```

### 4. 리뷰 팩트체크 연동
- 리뷰에서 언급된 제품명 추출
- nutrition_info 테이블에서 해당 제품 영양성분 조회
- 리뷰 내용과 실제 영양성분 비교

## 다음 단계

1. **제품명 매칭 로직 구현**
   - 기존 products 테이블과 nutrition_info 연결
   - 유사도 기반 제품명 매칭 알고리즘

2. **영양성분 검증 API 개발**
   - 제품명 입력 → 영양성분 반환
   - 리뷰 내용 vs 실제 영양성분 비교

3. **Streamlit 대시보드 연동**
   - 영양성분 정보 시각화
   - 제품 비교 기능 추가

4. **데이터 정기 업데이트**
   - 식약처 API 연동 검토
   - 자동 업데이트 스크립트 작성

## 배운 점

### 1. CSV 인코딩 주의사항
- 파일의 실제 인코딩을 먼저 확인할 것
- BOM (Byte Order Mark) 처리 필수
- `file -bi` 명령어로 인코딩 추측 가능하지만 완벽하지 않음

### 2. Supabase DDL 실행 제약
- Supabase JS SDK는 SELECT/INSERT/UPDATE/DELETE만 지원
- DDL (CREATE/ALTER/DROP)은 웹 콘솔 또는 PostgreSQL 클라이언트 필요

### 3. 대용량 데이터 업로드
- 배치 처리로 성능 향상 (1000건씩)
- upsert + onConflict로 중복 처리
- 진행률 표시로 사용자 경험 개선

### 4. 데이터 타입 선택
- NUMERIC vs FLOAT: 정확한 소수점 필요 시 NUMERIC
- TEXT vs VARCHAR: 길이 제한 없을 경우 TEXT 선호
- TIMESTAMPTZ: 타임존 포함 타임스탬프

## 참고 자료
- [Supabase SQL Editor](https://supabase.com/docs/guides/database/overview)
- [PostgreSQL NUMERIC Type](https://www.postgresql.org/docs/current/datatype-numeric.html)
- [csv-parse Documentation](https://csv.js.org/parse/)
- [식품의약품안전처 공공데이터](https://www.data.go.kr/)
