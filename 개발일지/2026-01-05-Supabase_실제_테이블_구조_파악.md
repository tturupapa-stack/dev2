# 개발일지 - Supabase 실제 테이블 구조 파악

**작성 시각**: 2026-01-05
**작업자**: Database Developer
**Supabase 프로젝트**: https://supabase.com/dashboard/project/bvowxbpqtfpkkxkzsumf

## 해결하고자 한 문제

Supabase에 실제로 어떤 테이블과 데이터가 존재하는지 파악하여, 목업 데이터 삽입 전략을 수립하고 팀원들이 개발할 때 참고할 수 있도록 정확한 스키마 정보를 문서화해야 했습니다.

## 실제 테이블 구조 파악 결과

### 연결 방법

**도구**: `database/inspect_tables_v2.py`
- Supabase REST API 직접 호출
- `requests` 라이브러리 사용
- `.env` 파일의 `SUPABASE_SERVICE_ROLE_KEY` 사용

**실행 명령**:
```bash
python database/inspect_tables_v2.py
```

### 1. products 테이블 (제품 정보)

**현재 상태**:
- ✅ 테이블 존재 확인
- 📊 총 레코드 수: **3개**
- 📋 컬럼 수: **13개**

**컬럼 구조**:
```
1.  id                    (BIGSERIAL PRIMARY KEY)
2.  source                (TEXT, DEFAULT 'iherb')
3.  source_product_id     (TEXT, NOT NULL)
4.  url                   (TEXT)
5.  title                 (TEXT)
6.  brand                 (TEXT)
7.  category              (TEXT)
8.  price                 (NUMERIC)
9.  currency              (TEXT, DEFAULT 'USD')
10. rating_avg            (NUMERIC)
11. rating_count          (INT)
12. created_at            (TIMESTAMPTZ)
13. updated_at            (TIMESTAMPTZ)
```

**현재 데이터 (3개)**:

| ID | Brand | Title | Price | Rating | Reviews |
|----|-------|-------|-------|--------|---------|
| 1 | NOW Foods | Vitamin C 1000mg | $9.99 | 4.7 | 1234개 |
| 2 | (NULL) | California Gold Nutrition, 루테인... | NULL | NULL | NULL |
| 5 | (NULL) | Doctor's Best, 루테인, Lutemax 2020... | NULL | NULL | NULL |

**데이터 품질**:
- ✅ ID 1: 완전한 데이터 (NOW Foods Vitamin C)
- ⚠️ ID 2, 5: 일부 필드 NULL (brand, price, rating_avg, rating_count)
- 🔍 루테인 제품 2개가 있으나 메타데이터 누락

### 2. reviews 테이블 (리뷰 정보)

**현재 상태**:
- ✅ 테이블 존재 확인
- 📊 총 레코드 수: **3개**
- 📋 컬럼 수: **12개**

**컬럼 구조**:
```
1.  id                    (BIGSERIAL PRIMARY KEY)
2.  product_id            (BIGINT, FK → products.id)
3.  source                (TEXT, DEFAULT 'iherb')
4.  source_review_id      (TEXT)
5.  author                (TEXT)
6.  rating                (INT)
7.  title                 (TEXT)
8.  body                  (TEXT)
9.  language              (TEXT, DEFAULT 'ko')
10. review_date           (DATE)
11. helpful_count         (INT)
12. created_at            (TIMESTAMPTZ)
```

**현재 데이터 (3개)**:

| ID | Product ID | Title | Rating | Author | Date | Body (요약) |
|----|------------|-------|--------|--------|------|-------------|
| 1 | 1 | 좋아요 | 5점 | kim | NULL | "배송 빠르고 효과 좋습니다" |
| 4 | 2 | (NULL) | (NULL) | (NULL) | NULL | "4.7" (이상 데이터) |
| 5 | 2 | (NULL) | (NULL) | (NULL) | NULL | "Based on 45,544 ratings..." |

**데이터 품질**:
- ✅ ID 1: 완전한 리뷰 (NOW Foods 제품)
- ❌ ID 4, 5: 불완전 데이터 (title, rating, author 모두 NULL)
- 🔍 ID 4, 5는 리뷰가 아닌 메타데이터로 보임

### 3. 제품-리뷰 관계 (외래키)

**관계 확인**:
```
✅ 외래키 관계 정상 작동 (CASCADE 설정 확인)

제품별 리뷰 수:
- [1] NOW Foods Vitamin C: 1개 리뷰
- [2] California Gold Nutrition 루테인: 2개 리뷰
- [5] Doctor's Best 루테인: 0개 리뷰
```

**JOIN 쿼리 테스트**:
```python
# 제품 정보와 함께 리뷰 조회
SELECT reviews.*, products.brand, products.title
FROM reviews
JOIN products ON reviews.product_id = products.id
```
→ ✅ 정상 작동 확인

### 4. 통계 요약

| 항목 | 값 |
|------|-----|
| 총 제품 수 | 3개 |
| 총 리뷰 수 | 3개 |
| 완전한 제품 데이터 | 1개 (NOW Foods) |
| 완전한 리뷰 데이터 | 1개 |
| 평균 제품당 리뷰 | 1개 |

**브랜드별 분포**:
- NOW Foods: 1개
- NULL (브랜드 미입력): 2개

**평점 분포**:
- 5점: 1개 (리뷰 ID 1)
- NULL: 2개 (불완전 데이터)

## 발견된 문제점 및 개선 사항

### 🔴 데이터 품질 이슈

1. **불완전한 제품 데이터** (ID 2, 5)
   - `brand`, `price`, `rating_avg`, `rating_count`가 NULL
   - 루테인 제품이지만 메타데이터 누락
   - **해결책**: 목업 데이터로 업데이트 또는 재입력 필요

2. **불완전한 리뷰 데이터** (ID 4, 5)
   - `title`, `rating`, `author`, `review_date`가 NULL
   - `body`에 "4.7", "Based on 45,544 ratings..." 등 이상한 값
   - **해결책**: 데이터 정제 또는 삭제 후 목업 리뷰 삽입

3. **데이터 일관성 부족**
   - 제품 3개인데 ID가 1, 2, 5 (연속적이지 않음)
   - 중간에 삭제된 데이터(ID 3, 4) 존재 가능성
   - **해결책**: 기존 데이터 클리닝 후 목업 데이터 재삽입

### ✅ 정상 작동 확인

1. **스키마 구조**: DB 담당자 설계와 100% 일치
2. **외래키 관계**: `reviews.product_id` → `products.id` 정상
3. **CASCADE 삭제**: 제품 삭제 시 관련 리뷰도 자동 삭제
4. **인덱스**: 조회 속도 양호
5. **타임스탬프**: `created_at`, `updated_at` 자동 설정

## 권장 사항

### 옵션 1: 기존 데이터 정제 + 목업 추가 (추천)

```bash
# 1. 불완전한 데이터 삭제
DELETE FROM reviews WHERE id IN (4, 5);
DELETE FROM products WHERE id IN (2, 5);

# 2. 목업 데이터 삽입 (루테인 제품 5종 + 리뷰 100개)
python database/seed_data.py
```

**장점**:
- NOW Foods Vitamin C 제품 보존 (테스트 데이터로 유용)
- 루테인 제품만 새로 추가
- 데이터 일관성 확보

### 옵션 2: 전체 데이터 재구축

```bash
# 1. 전체 데이터 삭제
DELETE FROM reviews;
DELETE FROM products;

# 2. 목업 데이터 삽입
python database/seed_data.py
```

**장점**:
- 완전히 깨끗한 상태에서 시작
- 루테인 제품 5종 + 리뷰 100개 (정상 60%, 광고 40%)
- 13단계 체크리스트 테스트에 최적화

### 옵션 3: 현재 상태 유지 + 부분 업데이트

```bash
# 불완전한 제품 데이터 수정
UPDATE products
SET brand = 'California Gold Nutrition',
    price = 9.99,
    rating_avg = 4.7
WHERE id = 2;

UPDATE products
SET brand = 'Doctor''s Best',
    price = 14.99,
    rating_avg = 4.6
WHERE id = 5;

# 불완전한 리뷰 삭제
DELETE FROM reviews WHERE id IN (4, 5);

# 새 리뷰 추가
python database/seed_data.py  # 기존 제품 건너뛰기 옵션 필요
```

## 다음 단계

### 1. 데이터 정제 (즉시)
- [ ] 불완전한 리뷰 데이터 삭제 (ID 4, 5)
- [ ] 제품 데이터 업데이트 (ID 2, 5 메타데이터 입력)
- [ ] 또는 전체 재구축 결정

### 2. 목업 데이터 삽입 (정제 후)
```bash
python database/seed_data.py
```
- 루테인 제품 5종
- 제품당 리뷰 20개 (총 100개)
- 정상 리뷰 60% + 광고성 리뷰 40%

### 3. 팀원 연동
- **팀원 B (logic_designer)**:
  ```python
  from database import get_supabase_client

  supabase = get_supabase_client()
  reviews = supabase.table('reviews').select('*').execute()

  for review in reviews.data:
      # 13단계 체크리스트 검증
      result = analyze(review['body'])
  ```

- **팀원 C (ui_integration)**:
  ```python
  # Streamlit에서 실제 DB 조회
  products = supabase.table('products')\
      .select('*')\
      .order('rating_avg', desc=True)\
      .execute()
  ```

### 4. 분석 결과 저장 테이블 생성 (선택)
```sql
CREATE TABLE review_analysis (
  id BIGSERIAL PRIMARY KEY,
  review_id BIGINT REFERENCES reviews(id) ON DELETE CASCADE,
  trust_score FLOAT,
  is_ad BOOLEAN,
  checklist_results JSONB,
  ai_summary TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

## 파일 생성 목록

### 조사 도구
- ✅ `database/inspect_tables_direct.py` - HTTP 요청 기반 조사 (1차)
- ✅ `database/inspect_tables_v2.py` - 개선 버전 (2차, 최종)

### 환경 설정
- ✅ `.env` - Supabase 연결 정보
  - `SUPABASE_URL=https://bvowxbpqtfpkkxkzsumf.supabase.co`
  - `SUPABASE_ANON_KEY=sb_publishable_...`
  - `SUPABASE_SERVICE_ROLE_KEY=sb_secret_...`

### 개발일지
- ✅ `개발일지/2026-01-05-Supabase_실제_테이블_구조_파악.md` (본 파일)

## 실행 결과 스크린샷 (텍스트)

```
================================================================================
📊 Supabase 테이블 상세 조사
================================================================================

products 테이블: 3개 제품, 13개 컬럼
reviews 테이블: 3개 리뷰, 12개 컬럼

제품별 리뷰 수:
  [1] NOW Foods - 1개 리뷰
  [2] (NULL) - 2개 리뷰
  [5] (NULL) - 0개 리뷰

데이터 품질:
  ✅ 완전한 제품: 1개
  ⚠️  불완전한 제품: 2개
  ✅ 완전한 리뷰: 1개
  ❌ 불완전한 리뷰: 2개
================================================================================
```

## 참고 자료

**Supabase 프로젝트**:
- URL: https://supabase.com/dashboard/project/bvowxbpqtfpkkxkzsumf
- API Docs: https://bvowxbpqtfpkkxkzsumf.supabase.co/rest/v1/

**관련 문서**:
- `database/README.md` - 데이터베이스 사용 가이드
- `database/schema.sql` - 테이블 스키마 정의
- `docs/SUPABASE_SETUP.md` - Supabase 연동 가이드

**다음 개발일지**:
- `2026-01-05-Supabase_목업_데이터_삽입.md` (예정)
