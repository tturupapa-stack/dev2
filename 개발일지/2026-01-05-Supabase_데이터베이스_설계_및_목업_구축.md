# 개발일지 - Supabase 데이터베이스 설계 및 목업 데이터 구축

**작성 시각**: 2026-01-05
**작업자**: Database Developer
**Supabase 프로젝트**: https://supabase.com/dashboard/project/bvowxbpqtfpkkxkzsumf

## 해결하고자 한 문제

DB 담당자가 제공한 테이블 스키마를 기반으로 Supabase 데이터베이스를 구축하고, iHerb 루테인 제품 5종과 리뷰 100개의 목업 데이터를 생성하여 팩트체크 시스템 테스트 환경을 마련해야 했습니다.

기존 CLAUDE.md에 명시된 스키마와 DB 담당자의 스키마가 달라 통일이 필요했고, 실제 데이터를 스크래핑하기 전 시스템 검증을 위한 현실적인 목업 데이터가 필요했습니다.

## 해결된 것

### 1. 데이터베이스 스키마 정의
✅ **파일**: `database/schema.sql`

**스키마 구조:**

#### products 테이블
```sql
CREATE TABLE public.products (
  id BIGSERIAL PRIMARY KEY,
  source TEXT NOT NULL DEFAULT 'iherb',
  source_product_id TEXT NOT NULL,
  url TEXT,
  title TEXT,
  brand TEXT,
  category TEXT,
  price NUMERIC,
  currency TEXT DEFAULT 'USD',
  rating_avg NUMERIC,
  rating_count INT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  updated_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (source, source_product_id)
);
```

**주요 특징:**
- `source` + `source_product_id` 유니크 제약으로 중복 방지
- `updated_at` 자동 갱신 트리거 설정
- 인덱스 최적화 (source, brand, product_id, rating, review_date)

#### reviews 테이블
```sql
CREATE TABLE public.reviews (
  id BIGSERIAL PRIMARY KEY,
  product_id BIGINT NOT NULL REFERENCES products(id) ON DELETE CASCADE,
  source TEXT NOT NULL DEFAULT 'iherb',
  source_review_id TEXT,
  author TEXT,
  rating INT,
  title TEXT,
  body TEXT,
  language TEXT DEFAULT 'ko',
  review_date DATE,
  helpful_count INT,
  created_at TIMESTAMPTZ DEFAULT NOW(),
  UNIQUE (source, source_review_id)
);
```

**주요 특징:**
- `product_id` 외래키로 CASCADE 삭제 설정
- 리뷰 고유 ID로 중복 방지
- 평점(1-5), 도움이 됨 투표 수 등 팩트체크에 필요한 필드 포함

### 2. 목업 데이터 설계
✅ **파일**: `database/mock_data.py`

**제품 데이터 (5종):**
1. Now Foods - Lutein, 10 mg, 120 Softgels ($15.99)
2. Jarrow Formulas - Lutein, 20 mg, 60 Softgels ($16.47)
3. Doctor's Best - Lutein with OptiLut, 10 mg, 120 Veggie Caps ($14.24)
4. Solgar - Lutein, 20 mg, 60 Softgels ($24.99)
5. Life Extension - MacuGuard Ocular Support with Saffron ($22.50)

**리뷰 데이터 (100개 = 제품당 20개):**
- **정상 리뷰 60% (12개/제품)**: 실제 사용 경험 기반, 개인적 표현 포함
- **광고성 리뷰 40% (8개/제품)**: 과장된 표현, 감탄사 남발, 비현실적 효과 강조

**리뷰 템플릿 예시:**

*정상 리뷰:*
```
제목: "눈 건강에 도움이 되는 것 같아요"
본문: "한달 정도 먹어보니까 눈이 좀 덜 피곤한 것 같습니다.
       컴퓨터 오래 보는 직업이라 구매했는데 괜찮네요."
평점: 4점
```

*광고성 리뷰:*
```
제목: "최고의 루테인! 강력 추천합니다!!!"
본문: "와 진짜 대박이에요!!! 먹자마자 바로 효과 느꼈어요!!
       시력이 1.0에서 1.5로 올랐어요!!! 최고최고!!"
평점: 5점
```

### 3. 데이터 삽입 스크립트
✅ **파일**: `database/seed_data.py`

**기능:**
- Supabase 서비스 역할 클라이언트 사용 (관리자 권한)
- 기존 데이터 삭제 옵션 (테스트 재실행 시 유용)
- 제품 5개 → 리뷰 100개 순차 삽입
- 실시간 진행 상황 표시
- 데이터 검증 (제품 수, 리뷰 수, 제품별 리뷰 수 확인)

**실행 방법:**
```bash
python database/seed_data.py
```

### 4. CRUD 테스트 스크립트
✅ **파일**: `database/test_crud.py`

**테스트 항목 (9가지):**
1. ✅ 제품 생성 (CREATE)
2. ✅ 제품 조회 (READ) - 전체/브랜드별/가격범위/정렬
3. ✅ 제품 수정 (UPDATE) - 가격, 평점 업데이트
4. ✅ 리뷰 생성 (CREATE)
5. ✅ 리뷰 조회 (READ) - 전체/제품별/평점별/최신순
6. ✅ 리뷰 수정 (UPDATE) - 도움이 됨 카운트
7. ✅ 조인 쿼리 (JOIN) - 제품 정보와 리뷰 조인
8. ✅ 리뷰 삭제 (DELETE)
9. ✅ 제품 삭제 (DELETE) - CASCADE로 관련 리뷰도 삭제

**실행 방법:**
```bash
python database/test_crud.py
```

### 5. 테이블 구조 조사 스크립트
✅ **파일**: `database/inspect_tables.py`

**기능:**
- 실제 Supabase의 테이블 구조 확인
- 샘플 데이터 조회 및 컬럼 타입 확인
- 제품별/평점별 통계 정보 출력
- 외래키 관계 검증 (JOIN 테스트)

**실행 방법:**
```bash
python database/inspect_tables.py
```

### 6. 문서화
✅ **파일**: `database/README.md`

**포함 내용:**
- 디렉토리 구조 설명
- 테이블 스키마 상세 설명
- 환경 설정 가이드 (.env 파일)
- 스키마 적용 방법
- 목업 데이터 삽입 방법
- CRUD 테스트 실행 방법
- Python 코드 사용 예제
- 쿼리 예제 (검색, 조인, 통계)
- 문제 해결 가이드

## Supabase Table Editor 현황

**프로젝트 URL**: https://supabase.com/dashboard/project/bvowxbpqtfpkkxkzsumf

**예상 테이블 구조:**

### products (제품 테이블)
| 필드 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | bigserial | PRIMARY KEY | 자동 증가 ID |
| source | text | NOT NULL, DEFAULT 'iherb' | 출처 |
| source_product_id | text | NOT NULL, UNIQUE(source) | iHerb 상품 ID |
| url | text | | 제품 URL |
| title | text | | 제품명 |
| brand | text | INDEX | 브랜드명 |
| category | text | | 카테고리 |
| price | numeric | | 가격 |
| currency | text | DEFAULT 'USD' | 통화 |
| rating_avg | numeric | | 평균 평점 |
| rating_count | int | | 평점 개수 |
| created_at | timestamptz | DEFAULT NOW() | 생성 시간 |
| updated_at | timestamptz | AUTO UPDATE | 수정 시간 |

**데이터 예시:**
```json
{
  "id": 1,
  "source": "iherb",
  "source_product_id": "NOW-03212",
  "url": "https://kr.iherb.com/pr/now-foods-lutein-10-mg-120-softgels/3212",
  "title": "Lutein, 10 mg, 120 Softgels",
  "brand": "Now Foods",
  "category": "루테인",
  "price": 15.99,
  "currency": "USD",
  "rating_avg": 4.5,
  "rating_count": 2847
}
```

### reviews (리뷰 테이블)
| 필드 | 타입 | 제약조건 | 설명 |
|------|------|----------|------|
| id | bigserial | PRIMARY KEY | 자동 증가 ID |
| product_id | bigint | FOREIGN KEY, CASCADE DELETE, INDEX | 제품 ID |
| source | text | NOT NULL, DEFAULT 'iherb' | 출처 |
| source_review_id | text | UNIQUE(source) | iHerb 리뷰 ID |
| author | text | | 작성자 |
| rating | int | INDEX | 평점 (1-5) |
| title | text | | 리뷰 제목 |
| body | text | | 리뷰 본문 |
| language | text | DEFAULT 'ko' | 언어 |
| review_date | date | INDEX | 리뷰 작성일 |
| helpful_count | int | | 도움이 됨 투표 수 |
| created_at | timestamptz | DEFAULT NOW() | 생성 시간 |

**데이터 예시:**
```json
{
  "id": 1,
  "product_id": 1,
  "source": "iherb",
  "source_review_id": "NORM-0-001",
  "author": "user1234",
  "rating": 4,
  "title": "눈 건강에 도움이 되는 것 같아요",
  "body": "한달 정도 먹어보니까 눈이 좀 덜 피곤한 것 같습니다...",
  "language": "ko",
  "review_date": "2025-11-20",
  "helpful_count": 12
}
```

## 향후 개발을 위한 컨텍스트 정리

### 데이터베이스 사용법

#### 1. 환경 설정
```bash
# .env 파일 생성
cat > .env << EOF
ANTHROPIC_API_KEY=your_key_here
SUPABASE_URL=https://bvowxbpqtfpkkxkzsumf.supabase.co
SUPABASE_ANON_KEY=your_anon_key
SUPABASE_SERVICE_ROLE_KEY=your_service_role_key
EOF

# 패키지 설치
pip install -r requirements.txt
```

#### 2. 스키마 적용
Supabase Dashboard → SQL Editor에서 `database/schema.sql` 실행

#### 3. 목업 데이터 삽입
```bash
python database/seed_data.py
```

#### 4. Python 코드에서 사용
```python
from database import get_supabase_client

# 클라이언트 가져오기
supabase = get_supabase_client()

# 제품 조회
products = supabase.table('products')\
    .select('*')\
    .eq('brand', 'Now Foods')\
    .execute()

# 제품의 리뷰 조회 (조인)
reviews = supabase.table('reviews')\
    .select('*, products(brand, title)')\
    .eq('product_id', 1)\
    .execute()
```

### 파일 구조

```
database/
├── __init__.py                 # 모듈 초기화
├── supabase_client.py          # Supabase 클라이언트 (기존)
├── test_connection.py          # 연결 테스트 (기존)
├── schema.sql                  # 데이터베이스 스키마 (NEW)
├── mock_data.py                # 목업 데이터 생성 (NEW)
├── seed_data.py                # 데이터 삽입 스크립트 (NEW)
├── test_crud.py                # CRUD 테스트 (NEW)
├── inspect_tables.py           # 테이블 구조 조사 (NEW)
└── README.md                   # 사용 가이드 (NEW)

docs/
└── SUPABASE_SETUP.md           # Supabase 연동 가이드 (기존)

개발일지/
└── 2026-01-05-Supabase_데이터베이스_설계_및_목업_구축.md (본 파일)
```

### 다음 단계

1. **팀원 B (logic_designer) 연동**
   - `logic_designer` 모듈에서 Supabase 데이터 조회
   - 13단계 체크리스트로 리뷰 분석
   - 신뢰도 점수 계산 및 DB 저장

2. **팀원 C (ui_integration) 연동**
   - Streamlit에서 Supabase 데이터 조회
   - Mock 데이터 대신 실제 DB 데이터 사용
   - 실시간 필터링 및 정렬

3. **실제 데이터 수집 (선택)**
   - iHerb 스크래핑 스크립트 작성
   - `seed_data.py` 대신 실제 데이터 삽입
   - 더 많은 제품 및 리뷰 수집

4. **분석 결과 저장 테이블 추가**
   ```sql
   CREATE TABLE review_analysis (
     id BIGSERIAL PRIMARY KEY,
     review_id BIGINT REFERENCES reviews(id),
     trust_score FLOAT,
     is_ad BOOLEAN,
     checklist_results JSONB,
     ai_analysis JSONB,
     created_at TIMESTAMPTZ DEFAULT NOW()
   );
   ```

## 통계 정보

### 목업 데이터 현황
- **총 제품 수**: 5개
- **총 리뷰 수**: 100개
- **제품당 평균 리뷰**: 20개
- **정상 리뷰**: 60개 (60%)
- **광고성 리뷰**: 40개 (40%)

### 브랜드별 제품 수
- Now Foods: 1개
- Jarrow Formulas: 1개
- Doctor's Best: 1개
- Solgar: 1개
- Life Extension: 1개

### 예상 평점 분포
- 5점: ~50개 (광고성 리뷰 대부분)
- 4점: ~35개 (정상 리뷰 다수)
- 3점: ~15개 (보통 리뷰)
- 2점 이하: ~0개

## 참고 자료

**Supabase 관련:**
- [Supabase 공식 문서](https://supabase.com/docs)
- [Supabase Python 클라이언트](https://github.com/supabase/supabase-py)
- 프로젝트 URL: https://supabase.com/dashboard/project/bvowxbpqtfpkkxkzsumf

**프로젝트 문서:**
- `database/README.md`: 상세 사용 가이드
- `docs/SUPABASE_SETUP.md`: Supabase 연동 가이드
- `CLAUDE.md`: 프로젝트 전체 개요

**관련 이슈:**
- DB 담당자 스키마 vs CLAUDE.md 스키마 통일
- 목업 데이터의 현실성 (광고성 리뷰 40% 비율)
- 13단계 체크리스트 검증 대상 데이터 확보
