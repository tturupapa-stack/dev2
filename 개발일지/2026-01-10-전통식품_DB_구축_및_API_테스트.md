# 전통식품 DB 구축 및 API 테스트

## 작업일: 2026-01-10

## 작업 개요
전통식품 정보 CSV 데이터를 Supabase에 업로드하고 마스터 테이블을 구축함. 식품의약품안전처 API 연동 테스트 진행.

## 주요 작업 내용

### 1. 식품의약품안전처 API 연동 테스트

**파일 수정:**
- `test-food-api.mjs`: URL을 https → http로 변경 (공공데이터포털 API 요구사항)
- `.env`: API 키 업데이트

**테스트 결과:**
- API 엔드포인트 연결: 성공 (HTTP 200)
- 인증: SERVICE KEY NOT REGISTERED ERROR 발생
- 원인: 공공데이터포털에서 해당 API 활용신청 필요

### 2. 전통식품 DB 테이블 구축

**Supabase 테이블 생성:**

#### traditional_foods (메인 테이블)
CSV 데이터 업로드용 테이블. 28개 컬럼으로 구성.

| 컬럼 | 설명 |
|-----|------|
| rep_code | 대표식품 코드 |
| rep_name | 대표 식품명 |
| trad_code | 전통 식품코드 |
| trad_name | 전통 식품명 |
| disease | 병증(원문, 한자) |
| disease_read | 병증(독음) |
| prescription | 처방(원문) |
| ingredients | 구성약제 |
| preparation | 조제법 |
| dosage | 복용법 |

#### foods_master (식품 마스터)
```sql
CREATE TABLE foods_master (
  id BIGSERIAL PRIMARY KEY,
  rep_code TEXT UNIQUE NOT NULL,
  rep_name TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```
- 등록 건수: **3,222건**

#### disease_master (병증 마스터)
```sql
CREATE TABLE disease_master (
  id BIGSERIAL PRIMARY KEY,
  disease TEXT UNIQUE NOT NULL,
  disease_read TEXT,
  disease_alias TEXT,
  disease_alias_read TEXT,
  modern_disease TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

#### prescription_master (처방 마스터)
```sql
CREATE TABLE prescription_master (
  id BIGSERIAL PRIMARY KEY,
  prescription TEXT UNIQUE NOT NULL,
  prescription_read TEXT,
  prescription_modern TEXT,
  prescription_alias TEXT,
  created_at TIMESTAMPTZ DEFAULT NOW()
);
```

### 3. CSV 데이터 처리

**헤더 변환:**
- 한글 컬럼명 → 영문 snake_case로 변환
- UTF-8 인코딩 확인 (한자 데이터 포함)

**업로드 방법:**
- Supabase Dashboard > Table Editor > Import CSV
- "First row as headers" 옵션 사용

## 기술 스택

- **Database**: Supabase (PostgreSQL)
- **인코딩**: UTF-8 (한자, 한글 지원)
- **API**: 공공데이터포털 (data.go.kr)

## 트러블슈팅

### Issue 1: API DNS 오류
**증상:** `getaddrinfo ENOTFOUND www.api.data.go.kr`

**원인:** https 사용 시 리다이렉트 문제

**해결:** URL을 `http://api.data.go.kr`로 변경

### Issue 2: Duplicate Key 오류
**증상:** `duplicate key value violates unique constraint`

**해결:**
```sql
INSERT INTO foods_master (rep_code, rep_name)
SELECT DISTINCT rep_code, rep_name
FROM traditional_foods
WHERE rep_code IS NOT NULL
ON CONFLICT (rep_code) DO NOTHING;
```

## 데이터 현황

| 테이블 | 건수 |
|-------|------|
| traditional_foods | - |
| foods_master | 3,222 |
| disease_master | - |
| prescription_master | - |

## 다음 단계

1. 공공데이터포털에서 API 활용신청 및 승인 대기
2. disease_master, prescription_master 건수 확인
3. 테이블 간 FK 연결 검토
4. 전통식품 검색 API 개발
